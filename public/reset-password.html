<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Jvala</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 24px;
      padding: 48px 40px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      display: block;
    }

    h1 {
      font-size: 28px;
      font-weight: 800;
      color: #1F2937;
      text-align: center;
      margin-bottom: 12px;
    }

    .subtitle {
      font-size: 15px;
      color: #6B7280;
      text-align: center;
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      font-family: 'Manrope', sans-serif;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      transition: all 0.2s;
      outline: none;
    }

    input:focus {
      border-color: #EC4899;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .password-requirements {
      margin-top: 12px;
      padding: 12px;
      background: #F9FAFB;
      border-radius: 8px;
      font-size: 13px;
    }

    .requirement {
      color: #6B7280;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }

    .requirement.met {
      color: #10B981;
    }

    .requirement::before {
      content: '•';
      margin-right: 8px;
      font-size: 16px;
    }

    .requirement.met::before {
      content: '✓';
      font-weight: bold;
    }

    button {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 700;
      font-family: 'Manrope', sans-serif;
      color: white;
      background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error {
      background: #FEF2F2;
      border: 1px solid #FCA5A5;
      color: #991B1B;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success-container {
      text-align: center;
      display: none;
    }

    .success-container.show {
      display: block;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .success-title {
      font-size: 24px;
      font-weight: 800;
      color: #1F2937;
      margin-bottom: 12px;
    }

    .success-message {
      font-size: 15px;
      color: #6B7280;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .button-secondary {
      background: white;
      color: #EC4899;
      border: 2px solid #EC4899;
      margin-top: 12px;
    }

    .button-secondary:hover:not(:disabled) {
      background: #FDF2F8;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      display: none;
    }

    button.loading .loading-text {
      display: inline;
    }

    button.loading .default-text {
      display: none;
    }

    @media (max-width: 480px) {
      .container {
        padding: 32px 24px;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Reset Form -->
    <div id="resetForm">
      <svg class="logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#EC4899" />
            <stop offset="100%" style="stop-color:#8B5CF6" />
          </linearGradient>
        </defs>
        <circle cx="50" cy="50" r="45" fill="url(#logoGradient)" />
        <path d="M35 40 L50 60 L65 40" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
      </svg>

      <h1>Reset Your Password</h1>
      <p class="subtitle">Enter a new password for your Jvala account</p>

      <div class="error" id="errorMessage"></div>

      <form id="passwordForm">
        <div class="form-group">
          <label for="password">New Password</label>
          <input
            type="password"
            id="password"
            placeholder="Enter new password"
            required
            minlength="8"
          />
          <div class="password-requirements">
            <div class="requirement" id="req-length">At least 8 characters</div>
            <div class="requirement" id="req-uppercase">One uppercase letter</div>
            <div class="requirement" id="req-lowercase">One lowercase letter</div>
            <div class="requirement" id="req-number">One number</div>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input
            type="password"
            id="confirmPassword"
            placeholder="Confirm new password"
            required
          />
        </div>

        <button type="submit" id="submitBtn">
          <span class="default-text">Reset Password</span>
          <span class="loading-text"><span class="spinner"></span>Resetting Password...</span>
        </button>
      </form>
    </div>

    <!-- Success Message -->
    <div class="success-container" id="successContainer">
      <div class="success-icon">✓</div>
      <h2 class="success-title">Password Reset!</h2>
      <p class="success-message">
        Your password has been successfully reset. You can now sign in to the Jvala app with your new password.
      </p>
      <button onclick="window.location.href='jvalaapp://auth/login'">
        Open Jvala App
      </button>
      <button class="button-secondary" onclick="window.close()">
        Close This Window
      </button>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    // Replace these with your actual Supabase project credentials
    const SUPABASE_URL = 'https://rvhpwjhemwvvdtnzmobs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2aHB3amhlbXd2dmR0bnptb2JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODAyMDgsImV4cCI6MjA3NTM1NjIwOH0.2g2DDjiaxZh9TDRLPm8OhyxeNj4NkSX91YoJbdgFvNM';

    // ===== PASSWORD VALIDATION =====
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    passwordInput.addEventListener('input', validatePassword);

    function validatePassword() {
      const password = passwordInput.value;

      // Check requirements
      const hasLength = password.length >= 8;
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);

      // Update UI
      updateRequirement('req-length', hasLength);
      updateRequirement('req-uppercase', hasUppercase);
      updateRequirement('req-lowercase', hasLowercase);
      updateRequirement('req-number', hasNumber);

      return hasLength && hasUppercase && hasLowercase && hasNumber;
    }

    function updateRequirement(id, met) {
      const element = document.getElementById(id);
      if (met) {
        element.classList.add('met');
      } else {
        element.classList.remove('met');
      }
    }

    // ===== FORM SUBMISSION =====
    const form = document.getElementById('passwordForm');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', handleSubmit);

    async function handleSubmit(e) {
      e.preventDefault();

      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Clear previous errors
      hideError();

      // Validate password strength
      if (!validatePassword()) {
        showError('Password does not meet requirements');
        return;
      }

      // Check passwords match
      if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }

      // Get access token from URL
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const type = hashParams.get('type');

      if (!accessToken || type !== 'recovery') {
        showError('Invalid or expired reset link. Please request a new password reset. (Links expire after 15 minutes)');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');

      try {
        // Update password via Supabase API
        const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to reset password');
        }

        // Show success
        document.getElementById('resetForm').style.display = 'none';
        document.getElementById('successContainer').classList.add('show');

      } catch (error) {
        console.error('Reset error:', error);
        showError(error.message || 'Failed to reset password. Please try again.');
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
    }

    function hideError() {
      errorMessage.classList.remove('show');
    }

    // ===== INITIALIZATION =====
    window.addEventListener('DOMContentLoaded', () => {
      // Check if we have a valid reset token
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const type = hashParams.get('type');

      if (!accessToken || type !== 'recovery') {
        showError('Invalid or expired reset link. Please request a new password reset from the app. (Links expire after 15 minutes)');
        submitBtn.disabled = true;
      }
    });
  </script>
</body>
</html>
