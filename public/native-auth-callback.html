<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jvala - Returning to app...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    .container { text-align: center; max-width: 340px; }
    .logo {
      width: 64px; height: 64px; margin: 0 auto 20px;
      border-radius: 16px;
      background: linear-gradient(135deg, #D6006C, #892EFF);
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
    }
    h1 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .subtitle { font-size: 14px; color: #888; margin-bottom: 24px; }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid #333; border-top-color: #D6006C;
      border-radius: 50%; animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .success { display: none; font-size: 14px; color: #4ade80; margin-bottom: 16px; }
    .hint { display: none; font-size: 13px; color: #999; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ðŸ”¥</div>
    <h1 id="title">Signing you in...</h1>
    <p class="subtitle" id="status">Securely transferring your session</p>
    <div class="spinner" id="spinner"></div>
    <p class="success" id="successMsg">âœ“ Done! You can close this window and return to Jvala.</p>
    <p class="hint" id="hint"></p>
  </div>

  <script>
    (function() {
      var hash = window.location.hash;
      var search = window.location.search;
      var params = new URLSearchParams(search);
      var nonce = params.get('nonce');

      // Supabase project URL for edge function
      var SUPABASE_URL = 'https://rvhpwjhemwvvdtnzmobs.supabase.co';
      var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2aHB3amhlbXd2dmR0bnptb2JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODAyMDgsImV4cCI6MjA3NTM1NjIwOH0.2g2DDjiaxZh9TDRLPm8OhyxeNj4NkSX91YoJbdgFvNM';

      function showSuccess() {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('title').textContent = 'Signed in!';
        document.getElementById('status').textContent = '';
        document.getElementById('successMsg').style.display = 'block';
        document.getElementById('hint').style.display = 'block';
        document.getElementById('hint').textContent = 'Close this window to return to Jvala';
      }

      function showError(msg) {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('title').textContent = 'Something went wrong';
        document.getElementById('status').textContent = msg || 'Please close this window and try again.';
      }

      function parseTokens(hashStr) {
        if (!hashStr || hashStr.length < 2) return null;
        var p = new URLSearchParams(hashStr.substring(1));
        var at = p.get('access_token');
        var rt = p.get('refresh_token');
        if (at && rt) return { access_token: at, refresh_token: rt };
        return null;
      }

      var tokens = parseTokens(hash);

      if (!tokens) {
        showError('No authentication tokens received.');
        return;
      }

      if (!nonce) {
        showError('Missing session nonce. Please try again.');
        return;
      }

      // POST tokens to edge function for the native app to retrieve
      fetch(SUPABASE_URL + '/functions/v1/native-token-relay', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({
          nonce: nonce,
          access_token: tokens.access_token,
          refresh_token: tokens.refresh_token,
        }),
      })
      .then(function(res) {
        if (!res.ok) throw new Error('Relay failed: ' + res.status);
        return res.json();
      })
      .then(function() {
        showSuccess();
        // Try to close the browser window (works in some contexts)
        try { window.close(); } catch(e) {}
      })
      .catch(function(err) {
        console.error('Token relay error:', err);
        // Even if relay fails, try the custom scheme as fallback
        var targetUrl = 'jvala://auth-callback' + hash;
        try { window.location.replace(targetUrl); } catch(e) {}
        setTimeout(function() {
          showError('Could not relay tokens. Please close this window and try signing in again.');
        }, 1500);
      });
    })();
  </script>
</body>
</html>
